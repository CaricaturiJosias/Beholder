
cmake_minimum_required(VERSION 3.22)

project(TEST)

#Here we add a Cmake Module ably to find GSOAP on your system, and find it
set(CMAKE_MODULE_PATH "${CORBA_DIR}/MsgProcessor/cmake")
include(${CMAKE_MODULE_PATH}/FindGSOAP.cmake)  # Replace 'your_custom_functions' with the actual filename

set(MSG_PROCESSOR_DIR ${CORBA_DIR}/MsgProcessor)

#Create the directory that will host files Generated by GSOAP
file(MAKE_DIRECTORY ${MSG_PROCESSOR_DIR}/Generated)

set (MAIN_CLIENT_SOURCE 
    ${MSG_PROCESSOR_DIR}/myapp.cpp
    ${MSG_PROCESSOR_DIR}/Generated/soapClient.cpp
    ${MSG_PROCESSOR_DIR}/Generated/soapC.cpp
)

set (MAIN_SERVER_SOURCE 
    ${MSG_PROCESSOR_DIR}/MsgProcessor.cpp
    ${MSG_PROCESSOR_DIR}/Generated/soapServer.cpp
    ${MSG_PROCESSOR_DIR}/Generated/soapC.cpp
)

set (WS_INTERFACE_BUILD_TARGET
    MsgProcessor.h 
)

#some files are Generated by gsoap
set_source_files_properties( ${MSG_PROCESSOR_DIR}/Generated/soapServer.cpp	 PROPERTIES GENERATED TRUE ) 
set_source_files_properties( ${MSG_PROCESSOR_DIR}/Generated/soapClient.cpp	 PROPERTIES GENERATED TRUE ) 
set_source_files_properties( ${MSG_PROCESSOR_DIR}/Generated/soapC.cpp	 PROPERTIES GENERATED TRUE ) 

#include .h folders here
include_directories( 
	${MSG_PROCESSOR_DIR}/Generated
)

#add the source files to the client executable
add_executable(GSOAP_SERVER ${MAIN_SERVER_SOURCE} )

#add the source files to the client executable
add_executable(GSOAP_CLIENT ${MAIN_CLIENT_SOURCE} )

#Create a cmake target that generate gsoap files
add_custom_command(
    OUTPUT ${MSG_PROCESSOR_DIR}/Generated/soapClient.cpp ${MSG_PROCESSOR_DIR}/Generated/soapServer.cpp ${MSG_PROCESSOR_DIR}/Generated/soapC.cpp
    COMMAND ${GSOAP_SOAPCPP2}  -d ${MSG_PROCESSOR_DIR}/Generated ${MSG_PROCESSOR_DIR}/${WS_INTERFACE_BUILD_TARGET}
    DEPENDS ${MSG_PROCESSOR_DIR}/${WS_INTERFACE_BUILD_TARGET}
    COMMENT "CREATING STUBS AND GLUE CODE"
)
    
add_custom_target(GSOAP_GENERATION_TARGET
	DEPENDS ${MSG_PROCESSOR_DIR}/Generated/soapClient.cpp)

#Make sure that the client is compiled only after gsoap has been processed
add_dependencies(GSOAP_CLIENT GSOAP_GENERATION_TARGET)
add_dependencies(GSOAP_SERVER GSOAP_GENERATION_TARGET)

set(DSMComms_DIR $ENV{HOME}/lib)
set(BEHOLDER_INC_DIR = /usr/include/DSMComms)
find_library(DSMComms NAMES libDSMComms.so PATHS ${DSMComms_DIR})
if (DSMComms)
    target_link_libraries(GSOAP_SERVER PRIVATE DSMComms ${GSOAP_CXX_LIBRARIES})
    target_link_libraries(GSOAP_CLIENT PRIVATE DSMComms ${GSOAP_CXX_LIBRARIES})
    target_include_directories(GSOAP_CLIENT PRIVATE ${BEHOLDER_INC_DIR} ${GSOAP_INCLUDE_DIR})
    target_include_directories(GSOAP_SERVER PRIVATE ${BEHOLDER_INC_DIR} ${GSOAP_INCLUDE_DIR})
else ()
    message(FATAL_ERROR "DSMComms.so not found in " ${DSMComms_DIR})
endif ()
